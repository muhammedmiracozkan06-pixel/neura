<script>
    // ==============================
    // AUTH KISMI AYNI
    // ==============================

    window.unlock = () => {
        document.getElementById("captcha-box").classList.add("hidden");
        document.getElementById("login-options").classList.remove("hidden");
    };

    window.onSignIn = (resp) => {
        const user = JSON.parse(atob(resp.credential.split('.')[1]));
        enterApp(user.name, "Google");
    };

    window.enterAsGuest = () => {
        enterApp("Misafir", "Guest");
    };

    function enterApp(name, provider) {
        document.getElementById("auth-overlay").style.display = "none";
        document.getElementById("main-app").style.display = "flex";
        document.getElementById("u-tag").textContent = "| " + provider;
        add("Neura MAX aktif. Sana nasıl yardımcı olabilirim?", "bot");
    }

    // ==============================
    // GEMINI CHAT KISMI
    // ==============================

    const API_KEY = "AIzaSyC3vsDyQyLMXkY2obLlK-VJLW11uKirK4Y";
    const MODEL = "gemini-1.5-flash"; 
    let history = [];

    async function talk() {
        const input = document.getElementById("q");
        const txt = input.value.trim();
        if (!txt) return;

        input.value = "";
        add(txt, "user");

        history.push({
            role: "user",
            parts: [{ text: txt }]
        });

        try {
            const r = await fetch(
                `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`,
                {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: history
                    })
                }
            );

            const d = await r.json();

            const reply = d.candidates[0].content.parts[0].text;

            history.push({
                role: "model",
                parts: [{ text: reply }]
            });

            add(reply, "bot");

        } catch (e) {
            add("❗ Gemini bağlantı hatası.", "bot");
        }
    }

    function add(t, c) {
        const div = document.createElement("div");
        div.className = "msg " + c;
        div.textContent = t;
        const box = document.getElementById("chat");
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    document.getElementById("q").addEventListener("keydown", e => {
        if (e.key === "Enter") talk();
    });
</script>
